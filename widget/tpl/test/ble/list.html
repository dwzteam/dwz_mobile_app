<form class="dwz-list-form page-wrap">
	<input type="hidden" name="pageNum" value="1">
	<header>
		<div class="toolbar">
			<div class="header-title">蓝牙设备</div>
		</div>
		<!-- <div class="toolbar">
			<div class="bar search-bar">
				<label class="item-input filter-keywords">
					<button class="icon icon-search" type="button"></button>
					<input type="search" class="dwz-disable-autofocus" name="keywords" value="" placeholder="车号、挂车号">
				</label>
			</div>
		</div> -->
	</header>

	<section>

		<div class="scroll-content dwz-list">
			<div class="scroll">
				<div class="pullDown">
					<span class="pullDownIcon">&nbsp;</span>
					<span class="pullDownLabel" data-flip="松开刷新">下拉刷新</span>
				</div>

				<div class="empty_box">
					<div class="empty-img">
						<img src="image/browse-empty-bg.svg">
					</div>
					<p class="txt-info is-center">暂时还没有数据哦~</p>
				</div>

				<ul class="list pic-list dwz-list-box">

				</ul>

				<div class="pullUp">
					<span class="pullUpIcon">&nbsp;</span><span class="pullUpLabel" data-loading="加载中..." data-no-more="没有更多了">加载更多</span>
				</div>

			</div>
			<a href="javascript:void(0)" class="top-btn hide">回顶部</a>
		</div>

	</section>
</form>

<script id="tpl_list" type="text/html">
	{{each list as item}}
	<li class="item dwz-ctl-hover" data-id="{{item.id}}" onclick="$.actionSheet.open({
		title:'{{item.name}}',
		buttons: ['设置密码', '查看详情', '删除']
	}, function(ret){
		$.alert.toast('buttonIndex: ' + ret.buttonIndex);

		if (ret.buttonIndex == 1) {
			var ble = api.require('ble');
			ble.writeValueForCharacteristic({
				peripheralUUID: '{{item.uuid}}',
				value: 'AAA101220A1111111144'
			}, function(ret) {
				if (ret) {
					api.alert({ msg: JSON.stringify(ret) });
				}
			});
		}
	})">
		<div class="item-content">
			<div class="txt-h3 txt-line1 flex-1">name：{{item.name}}</div>
			<div class="txt-info txt-line1">uuid：{{item.uuid}}</div>
			<div class="txt-info txt-line1">advertisingName：{{item.advertisingName}}</div>
			<div class="txt-info txt-line1">rssi：{{item.rssi}}</div>
			<div class="txt-info">manufacturerData：{{item.manufacturerData}}</div>
		</div>
	</li>
	{{/each}}
</script>



<script type="text/javascript">
	function helper(tpl, params) {
		// console.log(this, tpl, params)

		var html = template.render(tpl.html, {
			UserInfo: UserInfo
		});
		this.html(html).initUI();

		var $form = this.find('form.dwz-list-form'),
			$listBox = $form.find('ul.dwz-list-box');
		var ble = api.require('ble');
		$form.requestList = function(loadMore) {

			ble.initManager({
				single: false
			}, function(ret) {
				console.log(JSON.stringify(ret));
				if (ret.state == "poweredOn") {

					ble.scan({
						// serviceUUIDs: ['', '']
					}, function(ret) {
						console.log(JSON.stringify(ret))

						ble.getPeripheral(function(ret) {
							if (ret) {
								console.log(JSON.stringify(ret))

								$form.listTotal(ret.peripherals.length, ret.peripherals);
								if ($form.total) {
									$form.find('.empty_box').hide();
								}

								var _html = template.render(tpl.tpl_list, {
									list: ret.peripherals
								});

								$listBox.html(_html).initUI();
							}
						});
					});


				} else {
					$.alert.error('初始化蓝牙管理器失败')
				}
			});

		};

		$.listForm($form);
	}
</script>