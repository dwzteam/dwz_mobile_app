<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<title>title</title>
	<link rel="stylesheet" type="text/css" href="../css/api.css"/>
	<style>
		body{
			text-align: center;
		}
		button{
			width: 100%;
			height: 70px;
			line-height: 70px;
			background-color: #00ccff;
			color: #fff;
			text-align: center;
			margin-top:20px;
			border-radius: 8px;
		}
		#mapInfo{
			width: 100%;

			text-align: center;
		}
		header{
			width: 100%;
			line-height: 105px;
			height: 80px;
			background-color: green;
			text-align: center;
			color: #fff;
		}
	</style>
</head>
<body>
<header>
	bmLocation-demo
</header>
<div id="mapInfo"></div>
<!--<button type="button" name="button" onclick="getPermissionState()">获取授权验证码</button>-->
<!--<button type="button" name="button" onclick="configManager()">配置定位参数</button>-->
<!--<button type="button" name="button" onclick="singleLocation()">单次定位</button>-->
<!--<button type="button" name="button" onclick="StartBmap()">连续定位</button>-->
<!--<button type="button" name="button" onclick="stopLocation()">停止定位</button>-->
<!--<button type="button" name="button" onclick="trans()">经纬度坐标转换</button>-->
<!--<button type="button" name="button" onclick="judge()">是否在中国大陆</button>-->

车牌号：<input id="carno_input" type="text" name="carno" value="" onkeyup="this.value = this.value.toUpperCase()" onchange="carnoChange()"><!-- 浙A57H87 -->
<div id="view_map_bmap" style="height: 300px;"></div>

</body>
<script type="text/javascript" src="../script/api.js"></script>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=NwHaYlGalDEpgxm46xBaC3T9"></script>
<script type="text/javascript">
	var mapInfo = $api.byId('mapInfo');
	var carno_input = document.getElementById('carno_input');
	var map = new BMap.Map('view_map_bmap');


	apiready = function(){
		carno_input.value = $api.getStorage('carno');
		StartBmap();
		audioPlay();
	};

	function carnoChange() {
		$api.setStorage('carno', carno_input.value);
	}
	function audioPlay() {
		var audioStreamer = api.require('audioStreamer');
		audioStreamer.openPlayer({
			// path: 'http://7xisq1.com1.z0.glb.clouddn.com/apicloud/0d0b81b8bd5ab81bda9ca54267eb9b98.mp3'
			// path: 'http://www.7788sc.com/ui/mp3/bdspeech_recognition_success.mp3'
			path: 'http://www.7788sc.com/ui/mp3/1.mp3'
			// path: 'http://www.7788sc.com/ui/mp3/mute_1.mp3'
		}, function(ret) {
			if (ret.status) {
				console.log({ msg: JSON.stringify(ret) });
			}
		});
		audioStreamer.setLoop({loop:true});
		// audioStreamer.setVolume({
		// 	volume: 0.01
		// });
	}
	//连续定位开启
	function StartBmap(){
		$api.html(mapInfo,'定位开始');
		var num = 0;//次数
		var lastTime = 0;
		var bmLocation = api.require('bmLocation');

		bmLocation.configManager({
			accuracy: 'battery_saving', // battery_saving, device_sensors, hight_accuracy
			filter: 1,
			activityType:'automotiveNavigation',
			locationTimeout: 10,
			reGeocodeTimeout: 10,
			coordinateType:'BMK09LL' // BMK09LL, BMK09MC, WGS84, GCJ02
		});

		bmLocation.start({
			locatingWithReGeocode: true,
			backgroundLocation: true
		}, function(ret) {
			// console.log(JSON.stringify(ret));
			var sta = ret.status;
			if (sta) {
				var lat = ret.location.latitude;
				var lng = ret.location.longitude;
				// var timestamp = ret.location.timestamp/1000;
				var timestamp = Math.round(new Date().getTime()/1000);
				var str = '经度：' + lng + '<br>';
				str += '纬度：' + lat + '<br>';
				str += 'timestamp：' + timestamp + '<br>';
				num += 1;
				$api.html(mapInfo ,'第'+ num + '次' + str );

				map.clearOverlays();
				var point = new BMap.Point(lng, lat);
				// 创建标注对象并添加到地图
				var marker = new BMap.Marker(point);
				map.addOverlay(marker);
				map.centerAndZoom(point, 12);

				if (lastTime + 10 < timestamp) {
					console.log(lastTime, timestamp);

					lastTime = timestamp;
					api.ajax({
						url: 'http://yzdqyjg.818469.com:40080/api/addgoe',
						method: 'post',
						data: {
							values: {
								carno: carno_input.value,
								gathertime: timestamp,
								lng: lng,
								lat: lat
							}
						}
					}, function (json, err) {
						console.log(JSON.stringify(json));
					});
				}


			} else {
				api.alert({ msg: '发生错误' });
			}
		});
	}
	//停止定位
	function stopLocation(){
		var bmLocation = api.require('bmLocation');
		bmLocation.stopLocation();
		$api.html(mapInfo, '已停止');
	}
	//获取授权码
	function getPermissionState() {
		var bmLocation = api.require('bmLocation');
		bmLocation.getPermissionState(function(ret) {
			var sta = ret.code;
			$api.html(mapInfo, '授权码：' + sta);
		});
	}
	//配置 参数
	function configManager() {
		var bmLocation = api.require('bmLocation');
		bmLocation.configManager({
			accuracy: 'device_sensors',
			filter: 1,
			activityType:'automotiveNavigation',
			coordinateType:'GCJ02',
			locationTimeout: 10,
			reGeocodeTimeout: 10
		});
		$api.html(mapInfo, '已配置' );
	}
	//单次定位
	function singleLocation() {
		var bmLocation = api.require('bmLocation');
		bmLocation.singleLocation({
			reGeocode: true,
			netWorkState: false
		}, function(ret) {
			var sta = ret.status;
			if (sta) {
				var lat = ret.location.latitude;
				var lon = ret.location.longitude;
				var t = ret.timestamp;
				var str = '经度：' + lon + '<br>';
				str += '纬度：' + lat + '<br>';
				$api.html(mapInfo, '单次' + str );
			} else {
				$api.html(mapInfo, '单次错误');
			}
		});
	}
	//坐标格式转换
	function trans() {
		var bmLocation = api.require('bmLocation');
		bmLocation.trans({
			latitude: 116,
			latitude: 39,
			desType:'BMK09LL',
			srcType:'GCJ02'
		}, function(ret) {
			var sta = ret.status;
			if (sta) {
				var lat = ret.location.latitude;
				var lon = ret.location.longitude;
				var t = ret.timestamp;
				var str = '经度：' + lon + '<br>';
				str += '纬度：' + lat + '<br>';
				$api.html(mapInfo, '格式转换' + str);

			} else {
				api.alert({ msg: '发生错误' });
			}
		});
	}

	//判断是否在国内
	function judge() {
		var bmLocation = api.require('bmLocation');
		bmLocation.trans({
			latitude: 116,
			latitude: 39,
			coordinateType:'BMK09LL'
		}, function(ret) {
			var sta = ret.status;
			if (sta) {
				$api.html(mapInfo, '在');
				//api.alert({ msg: '在'  });
			} else {
				api.alert({ msg: '不在' });
			}
		});
	}
</script>
</html>
